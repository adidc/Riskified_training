---
title: "Telling stories with charts - visualizations with ggplot2"
author: "Adi Sarid"
output: html_document
---

# What for and why now?

When we think about the data science workflow, it makes a lot of sense to start our lesson with tidying data or data transformations, however, I chose to start with visualizations. Why is that?

I'm adopting the approach of the "R for Data Science book", which talks about visualizations in one of its early chapters (even before data transformations), because charts give a lot of motivation to our next chapters and also helps us develop a way of thinking.

As you will see, the following exercises will also contain some elements of tidying and transforming data (because sometimes its a necessity towards working on a chart). In a future lesson we will delve deeper and extend our knowledge into tidying and data transformations.

**Remember:**
When you do the exercises, if you get stuck, put on a pink sticky note. If I haven't noticed it, call me. If you finished, put up the green one.

# Exercise 1: the *google play* data set

In this exercise we will work with a file downloaded from the competition website kaggle. You can see the details [here](https://www.kaggle.com/lava18/google-play-store-apps). You are going to load the file directly from our course's repository, using the following command:

```{r load googleplay scraped data file}

suppressMessages(
   library(tidyverse)
   )
google_play_raw <- read_csv(file = "https://raw.githubusercontent.com/adisarid/Riskified_training/master/datasets/googleplaystore.csv")

```

**Question 1:** Did you notice I used the `supressMessages(...)` function. What does it do? Why did I use it?

**It was used because `tidyverse` overrides some commands and then throws out a nasty message. When using it in Rmarkdown it is a way (one of a few) to hide these messages.**

**Question 2:** Did you notice any "parsing failures" when reading the file? 
Try to figure out what do they mean, and think about how would you solve the problem. The error message contains a row location so you can look at the data in the area of the error to try and figure it out, e.g.: 

```
location <- ???
google_play_raw[(location-3):(location+3),]
```

Once you figure out what's wrong, filter this line out of the file (but note that there are other ways to handle this).

```
google_play <- google_play_raw[-location,]
```

**Since this file is the result of web scraping, some errors are expected, but in fact it is a relatively clean file. This parsing error is caused by the fact that the `read_csv` reads the first 10,000 lines and uses them to decide on data types of each column. The error is in row 10473, and is caused by the fact that there is a value missing from the line. Then all other values get pushed to the wrong position.**

**Question 3**: Is there any other way you could have filtered this messy line? (think about `filter()`, the `is.na()` and `!` operator)

```{r filter solution for parsing error}
google_play <- google_play_raw %>% 
   filter(!is.na(`Android Ver`))
```

Look at the dataset using `glimpse(???)`, notice that most columns were read as characters and a few as double.

**Question 4:** What variables were read as character but you think that you would be better off if they were tranformed to a different type?

**To factor: Category, Installs, Type, Content Rating, Genres, Android Ver.**
**To date: Last Updated.**
**To numeric: using string manipulation: Size (the app's size, perhaps also Installs).**

The `Category` variable represents the app's category. 

**Question 5:** Complete the code below and answer the questions that follow. Note that the last part of the code (`theme(...)`) is meant to rotate the x axis labels, for better readability. First try without it and then add it.

```{r show google play categories}
ggplot(data = google_play, mapping = aes(x = Category)) + 
   geom_bar()

ggplot(data = google_play, mapping = aes(x = Category)) + 
   geom_bar() + 
   theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


   1. What is the order by which the columns are sorted? **Lexicographic (abc...)**

Build a chart that shows which android versions are supported by each app.

**Question 6:** 

   1. What was the latest android version when the file was generated? **Probably 8.0+**
   2. Would you say that some categories of `Android Ver` should be grouped together? **Depends. for example 4.0.03-7.1.1 and 4.1-7.7.7 might be a proper grouping.**.


```{r versions}

ggplot(google_play, aes(x = `Android Ver`)) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 45))

```

In the following segment we will examine the relationship between the rating of an app and the number of users who rated it. Build a chart that will help you examine this relationship.

Hint: use a `geom_point()` with x as number of reviews and y as the average rank.

```{r rank reviews relationship}
ggplot(google_play, aes(x = Reviews, y = Rating)) + 
   geom_point() + 
   stat_smooth(method = "auto")
```

**Question 7:** 

   1. In the documentation of `stat_smooth` there are a number of smoothing methods. What did you choose and why? **Sometimes its a good guess to go with the default, in this case "auto". If that doesn't make sense - keep exploring. Loess is too sensitive and yields really unreasonable results. "lm" can also work, but the real deal is coming right up...**
   2. Do you see anything wrong with the chart? **Very few observations on the higher end of Reviews, but these are "significant" apps. Currently the graph doesn't make any sense.**
   3. Bonus: is there a transformation which you can use on the x-axis, for the chart to make more sense? What is it? **Use log(reviews) or use ggplot2's scale function for a log.**

```{r example for axis rescale with log}
# like this:
ggplot(google_play, aes(x = Reviews, y = Rating)) + 
   geom_point() + 
   stat_smooth(method = "auto") + 
   scale_x_log10()

# this will also work. spot the differences:
ggplot(google_play, aes(x = log(Reviews), y = Rating)) + 
   geom_point() + 
   stat_smooth(method = "auto")


```

**Question 8:** Use the function `cut` to split the number of reviews to five different groups. Generate a chart of rank versus reviews in which each new reviews-group is colored in different color.

```{r rating vs reviews cut}
# note the use of tidyverse here (%>%, mutate, etc.)
google_play_groups <- google_play %>% 
   mutate(reviews_group = cut(Reviews, breaks = c(10^(0:6), max(Reviews) + 1)))
   
rating_reviews_grouped_chart <- 
  ggplot(google_play_groups, aes(x = Reviews, y = Rating, color = reviews_group)) + 
  geom_point() + 
  stat_smooth(method = "lm") +
  scale_x_log10()

rating_reviews_grouped_chart
```

   1. Do you identify any new relationships? **If we examine linear regression it looks like the relationship between rating and log(reviews) flips between the groups.**
   2. Do specific ranges have stronger relationships than other ranges? **The coefficient of the lm model is smaller for Reviews < 10 and for reviews > 10^6.**

**Question 9:** Use a boxplot to compare the distribution of the number of reviews between free and paid apps

   1. What does this comparison tells you?
   2. Use a `log()` transformation on the number of reviews, and re-plot. What do you see now?
   3. Describe the difference between using `log(Reviews)` versus `scale_y_log()`.
   4. Compare the average rank of free apps versus paid apps. What does this comparison tells you?